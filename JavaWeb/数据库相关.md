

# 数据库相关

## JDBC

// todo

## Mybatis

### 1. 构建 SqlSessionFactory

#### 从 XML 

每个基于 MyBatis 的应用都是以一个 SqlSessionFactory 的实例为核心的。

SqlSessionFactory 的实例可以通过 SqlSessionFactoryBuilder 获得。

```java
String resource = "mybatis-config.xml";
InputStream inputStream = Resources.getResourceAsStream(resource);
SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);
```

XML 配置文件中包含了对 MyBatis 系统的核心设置，包括获取数据库连接实例的数据源（DataSource）以及决定事务作用域和控制方式的事务管理器（TransactionManager）。

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE configuration
  PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-config.dtd">
<configuration>
  <environments default="development">
    <environment id="development">
      <transactionManager type="JDBC"/>
      <dataSource type="POOLED">
        <property name="driver" value="${driver}"/>
        <property name="url" value="${url}"/>
        <property name="username" value="${username}"/>
        <property name="password" value="${password}"/>
      </dataSource>
    </environment>
  </environments>
  <mappers>
    <mapper resource="mapper.xml"/>
  </mappers>
</configuration>
```

#### 通过Configuration 实例

​	TODO

 +	

### 2. 编写pojo实体类

​	实体类要数据库列名一致

​	demo:

~~~java
private Integer a_Id;
private String a_Name;
private String a_Pass;
public Integer getA_Id() {
    return a_Id;
}
public void setA_Id(Integer a_Id) {
    this.a_Id = a_Id;
}
public String getA_Name() {
    return a_Name;
}
public void setA_Name(String a_Name) {
    this.a_Name = a_Name;
}
public String getA_Pass() {
    return a_Pass;
}
public void setA_Pass(String a_Pass) {
    this.a_Pass = a_Pass;
}
~~~

### 3. 编写Mapper接口和Mapper.xml

​	3.1.	Mapper接口

```java
interface AdminMapper {
    List<Admin> SelectAll();
}
```

3.2. Mapper.xml

~~~xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jvbac.study.mapper.AdminMapper" >
    <select id="SelectAll" resultType="com.jvbac.study.pojo.Admin">
        SELECT * FROM admin
    </select>
</mapper>
~~~



### 4. 运行查询

~~~java
SqlSession sqlSession = sqlSessionFactory.openSession();
String SqlId ="com.jvbac.study.mapper.AdminMapper.SelectAll";
List<Admin> list= sqlSession.selectList(SqlId);
for (Admin admin : list) {
    System.out.println(admin);
}
sqlSession.close();
~~~

### 增加、删除、修改 

> 注意：mybatis 默认是不提交事务 所以insert update delete，后要提交事务

~~~java
sqlSession.commit();
~~~



​	

## 常见问题

+ select出来的对象为null
   + 实体类和数据库列名不一致
   
+ mapper xml文件找不到,显示如下

  ~~~java
  Cause: org.apache.ibatis.builder.BuilderException: Error parsing SQL Mapper Configuration. Cause: java.io.IOException: Could not find resource com/jvbac/study/mapper/AdminMapper.xml
  	at org.apache.ibatis.exceptions.ExceptionFactory.wrapException(ExceptionFactory.java:26)
  	at org.apache.ibatis.session.SqlSessionFactoryBuilder.build(SqlSessionFactoryBuilder.java:82)
  	at org.apache.ibatis.session.SqlSessionFactoryBuilder.build(SqlSessionFactoryBuilder.java:66)
  	at com.jvbac.study.dao.MyBatisDemo.LoadForXml(MyBatisDemo.java:30)
  	at com.jvbac.study.dao.MyBatisDemo.main(MyBatisDemo.java:16)
  Caused by: org.apache.ibatis.builder.BuilderException: Error parsing SQL Mapper Configuration. Cause: java.io.IOException: Could not find resource com/jvbac/study/mapper/AdminMapper.xml
  	at org.apache.ibatis.builder.xml.XMLConfigBuilder.parseConfiguration(XMLConfigBuilder.java:109)
  	at org.apache.ibatis.builder.xml.XMLConfigBuilder.parse(XMLConfigBuilder.java:92)
  	at org.apache.ibatis.session.SqlSessionFactoryBuilder.build(SqlSessionFactoryBuilder.java:80)
  	... 3 more
  Caused by: java.io.IOException: Could not find resource com/jvbac/study/mapper/AdminMapper.xml
  	at org.apache.ibatis.io.Resources.getResourceAsStream(Resources.java:110)
  	at org.apache.ibatis.io.Resources.getResourceAsStream(Resources.java:97)
  	at org.apache.ibatis.builder.xml.XMLConfigBuilder.mapperElement(XMLConfigBuilder.java:320)
  	at org.apache.ibatis.builder.xml.XMLConfigBuilder.parseConfiguration(XMLConfigBuilder.java:107)
  	... 5 more
  ~~~
  
  ##### 如果使用的是IDEA构建
  
  mapper xml需要放置在resources下
  
  ##### 如果使用的是maven构建
  
  需要在 pom.xml  的project>build>resources下加入以下内容
  
  ```xml
  <resource>
      <directory>/src/main/java</directory>
      <includes>
          <include>**/*.properties</include>
          <include>**/*.xml</include>
      </includes>
      <filtering>false</filtering>
  </resource>
  </resources>
  ```
 ## 其他

### 设置日志输出

xml >configuration下

~~~xml
    <settings>
        <setting name="logImpl" value="STDOUT_LOGGING"/>
    </settings>
~~~





## Druid连接池

#### 使用方法

1.  直接创建连接池

   ~~~java
   public static void jdbc() throws Exception{
       Map<String,String> map=new HashMap<>();
       map.put("driverClassName","com.mysql.cj.jdbc.Driver");
       map.put("url","jdbc:mysql://localhost:3306/db?useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true");
       map.put("username","root");
       map.put("password","root");
       DataSource ds = DruidDataSourceFactory.createDataSource(map);
       Connection conn = ds.getConnection();
       //TODO jdbc
       conn.close();
   }
   ~~~

   2. 加载至配置文件

   ~~~java
           Properties pro = new Properties();
           InputStream ins = DruidDemo.class.getClassLoader().getResourceAsStream(filename);
           pro.load(ins);
           DataSource ds = DruidDataSourceFactory.createDataSource(pro);
   ~~~

   3. mybatis联合使用
   
      // todo
   
   4. xml配置文件
   
      // todo

#### 常见错误

##### 连接失败，检查服务是否开启， URL是否写错

~~~java
com.mysql.cj.jdbc.exceptions.CommunicationsException: Communications link failure

The last packet sent successfully to the server was 0 milliseconds ago. The driver has not received any packets from the server.
	at com.mysql.cj.jdbc.exceptions.SQLError.createCommunicationsException(SQLError.java:174)
	at com.mysql.cj.jdbc.exceptions.SQLExceptionsMapping.translateException(SQLExceptionsMapping.java:64)
	at com.mysql.cj.jdbc.ConnectionImpl.createNewIO(ConnectionImpl.java:836)
	at com.mysql.cj.jdbc.ConnectionImpl.<init>(ConnectionImpl.java:456)
	at com.mysql.cj.jdbc.ConnectionImpl.getInstance(ConnectionImpl.java:246)
	at com.mysql.cj.jdbc.NonRegisteringDriver.connect(NonRegisteringDriver.java:198)
	at com.alibaba.druid.pool.DruidAbstractDataSource.createPhysicalConnection(DruidAbstractDataSource.java:1375)
	at com.alibaba.druid.pool.DruidAbstractDataSource.createPhysicalConnection(DruidAbstractDataSource.java:1431)
	at com.alibaba.druid.pool.DruidDataSource$CreateConnectionThread.run(DruidDataSource.java:1844)
Caused by: com.mysql.cj.exceptions.CJCommunicationsException: Communications link failure

~~~

